<div class="container mt-4">
  <h2 class="mb-3">Doctor Leave Management</h2>

  <form id="leaveForm" class="border p-3 rounded bg-light">
    <div class="mb-3">
      <label for="leave_type" class="form-label">Leave Type</label>
      <select id="leave_type" class="form-select" required>
        <option value="">Select Type</option>
        <option value="Vacation">Vacation</option>
        <option value="Sick">Sick</option>
        <option value="Personal">Personal</option>
        <option value="Conference">Conference</option>
      </select>
    </div>

    <div class="row">
      <div class="col-md-6 mb-3">
        <label for="leave_start" class="form-label">Leave Start</label>
        <input type="date" id="leave_start" class="form-control" required />
      </div>
      <div class="col-md-6 mb-3">
        <label for="leave_end" class="form-label">Leave End</label>
        <input type="date" id="leave_end" class="form-control" required />
      </div>
    </div>

    <div class="mb-3">
      <label for="reason" class="form-label">Reason</label>
      <textarea id="reason" class="form-control" rows="3" placeholder="Brief reason..."></textarea>
    </div>

    <button type="submit" class="btn btn-primary w-100">Submit Leave Request</button>
  </form>

  <hr>

  <h4 class="mt-4">My Leave Requests</h4>
  <div id="leaveList" class="list-group mt-2"></div>
</div>

<script>
  frappe.ready(function() {
    const doctor = frappe.session.user;

    // ðŸ§  Load existing leave records
    function loadLeaves() {
      frappe.call({
        method: "frappe.client.get_list",
        args: {
          doctype: "Doctor Leave",
          filters: { doctor: doctor },
          fields: ["name", "leave_type", "leave_start", "leave_end", "status", "reason"],
          order_by: "creation desc"
        },
        callback: function(r) {
          const list = document.getElementById("leaveList");
          list.innerHTML = "";

          if (!r.message || r.message.length === 0) {
            list.innerHTML = "<p class='text-muted'>No leave requests yet.</p>";
            return;
          }

          r.message.forEach(l => {
            const item = document.createElement("div");
            item.className = "list-group-item list-group-item-action";
            item.innerHTML = `
              <strong>${l.leave_type}</strong> (${l.leave_start} â†’ ${l.leave_end})<br>
              <span class="text-muted small">${l.reason || "No reason"}</span><br>
              <span class="badge bg-${l.status === "Approved" ? "success" : l.status === "Pending" ? "warning" : "danger"}">${l.status}</span>
            `;
            list.appendChild(item);
          });
        }
      });
    }

    // ðŸ“¨ Handle form submission
    document.getElementById("leaveForm").addEventListener("submit", function(e) {
      e.preventDefault();

      const leaveData = {
        doctor: doctor,
        leave_type: document.getElementById("leave_type").value,
        leave_start: document.getElementById("leave_start").value,
        leave_end: document.getElementById("leave_end").value,
        reason: document.getElementById("reason").value,
        status: "Pending"
      };

      frappe.call({
        method: "frappe.client.insert",
        args: {
          doc: {
            doctype: "Doctor Leave",
            ...leaveData
          }
        },
        callback: function(r) {
          if (r.exc) {
            frappe.msgprint("Error submitting leave.");
            return;
          }
          frappe.msgprint("Leave request submitted!");
          loadLeaves();
          document.getElementById("leaveForm").reset();
        }
      });
    });

    loadLeaves();
  });
</script>

